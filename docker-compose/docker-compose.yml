# Переменные из `env_file` используется только при запуске контейнера. При
# сборке читается файл `.env`, если тот существует. Для сборки с произвольным
# env-файлом исп. docker-compose --env-file myenv. Т.о., запуск с произвольными
# настройками будет выглядеть так:
#
#   $ COMPOSE_ENV_FILE=/path/to/myenv docker-compose --env-file $COMPOSE_ENV_FILE up -d
#
# `.env` является лишь символической ссылкой на `default.env`. Это сделано для
# того чтобы запускать все без установки переменной COMPOSE_ENV_FILE и указания
# флага --env-file, т.е. чтобы с дефолтным пресетом все запустить выполняем:
#
#   $ docker-compose up -d
#
# Модифицируйте /etc/hosts чтобы иметь возможно обращаться к ресурсам по именам:
#
#  127.0.0.1 localhost wiki.localhost pgadmin.localhost mongodb-express.localhost
#
version: '3.7'

services:
  postgres:
    image: postgres:alpine
    container_name: postgres
    restart: unless-stopped
    env_file: ${COMPOSE_ENV_FILE:-.env}
    volumes:
      - pgdata:/var/lib/postgresql/data:rw
    ports:
      # из других контейнеров в общей сети нужно подключиться к postgres:5432
      # на хосте подключаемся к localhost:54321
      - "${POSTGRES_PORT:-54321}:5432"
    networks:
      - postgres

  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin
    depends_on:
      - postgres
    restart: unless-stopped
    env_file: ${COMPOSE_ENV_FILE:-.env}
    volumes:
      - pgadmin_data:/root/.pgadmin:rw
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    networks:
      - pgadmin
      - postgres
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin.rule=Host(`pgadmin.localhost`)"
      - "traefik.http.routers.pgadmin.entrypoints=web"

  mysql:
    image: mariadb:latest
    container_name: mysql
    restart: unless-stopped
    env_file: ${COMPOSE_ENV_FILE:-.env}
    volumes:
      - mysql_data:/var/lib/mysql:rw
    ports:
      - "${MYSQL_PORT:-33061}:3306"
    networks:
      - mysql

  mongodb:
    image: mongo:latest
    container_name: mongodb
    restart: unless-stopped
    env_file: ${COMPOSE_ENV_FILE:-.env}
    volumes:
      - mongo_data:/data/db:rw
    ports:
      - "${MONGODB_PORT:-37017}:27017"
    networks:
      - mongodb
    # Запрещаем автозапуск. См. `docker-compose --profile`
    profiles:
      - "cli-only"

  # веб-админка для mongodb
  mongo-express:
    image: mongo-express:latest
    container_name: mongo-express
    restart: unless-stopped
    env_file: ${COMPOSE_ENV_FILE:-.env}
    environment:
      ME_CONFIG_MONGODB_SERVER: 'mongodb'
      ME_CONFME_CONFIG_MONGODB_PORT: '27017'
      ME_CONFIG_MONGODB_AUTH_DATABASE: "${MONGO_INITDB_DATABASE}"
      ME_CONFIG_MONGODB_AUTH_USERNAME: "${MONGO_INITDB_ROOT_USERNAME}"
      ME_CONFIG_MONGODB_AUTH_PASSWORD: "${MONGO_INITDB_ROOT_PASSWORD}"
    ports:
      - "${MONGO_EXPRESS_PORT:-18081}:8081"
    networks:
      - mongo-express
      - mongodb
      - traefik
    depends_on:
      - mongodb
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mongo-express.rule=Host(`mongo-express.localhost`)"
      - "traefik.http.routers.mongo-express.entrypoints=web"
    profiles:
      - "cli-only"

  redis:
    image: redis:alpine
    container_name: redis
    restart: unless-stopped
    volumes:
      - redis_data:/var/lib/redis:rw
    ports:
      - "${REDIS_PORT:-63791}:6379"
    networks:
      - redis

  # Локальная вики
  # Чтобы заработала надо в postgres создать базу wiki
  wiki:
    image: requarks/wiki:latest
    container_name: wiki
    depends_on:
      - postgres
    restart: unless-stopped
    env_file: ${COMPOSE_ENV_FILE:-.env}
    environment:
      DB_TYPE: postgres
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: "${POSTGRES_USER}"
      DB_PASS: "${POSTGRES_PASSWORD}"
      DB_NAME: wiki
    ports:
      # 3000 порт по-дефолту в примерах для node.js
      - "${WIKI_PORT:-30001}:3000"
    networks:
      - wiki
      - postgres
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wiki.rule=Host(`wiki.localhost`)"
      - "traefik.http.routers.wiki.entrypoints=web"

  traefik:
    image: "traefik:latest"
    container_name: "traefik"
    command:
      #- "--log.level=DEBUG"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "${TRAEFIK_DASHBOARD_PORT:-9080}:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - traefik

volumes:
  pgdata:
  pgadmin_data:
  mysql_data:
  mongo_data:
  redis_data:

# некоторым можно добавить bridge.driver = 'local'
networks:
  postgres:
  pgadmin:
  mysql:
  mongodb:
  mongo-express:
  redis:
  wiki:
  traefik:
